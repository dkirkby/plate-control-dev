# Collision analysis settings
TIMESTEP = 0.02 # [seconds] time increment (i.e. resolution) for collision checking

# Mechanical geometry definitions for anticollision, see DESI-0899
PHI_EO        = 114.0 # [deg] poslocP angle above which phi is guaranteed to be within envelope Eo
PHI_EI        = 148.0 # [deg] poslocP angle above which phi is guaranteed to be within envelope Ei
ENVELOPE_EO   = 9.990 # [mm] outer clear rotation envelope
EO_RADIAL_TOL = 0.300 # [mm] margin (measured radially, not diametrially) on EO. Meant to account for manufacturing tolerances
ENVELOPE_EI   = 6.800 # [mm] inner clear rotation envelope
RESOLUTION_EO =    32 # number of points for polygon representation of outer clear rotation envelope
RESOLUTION_EI =    32 # number of points for polygon representation of inner clear rotation envelope
RESOLUTION_EE =    32 # number of points for polygon representation of extended clear rotation envelope

# Theta and phi keepout expansion parameters
# (negative values are treated as contractions)
# As of 2020-02-14, these global parameters are no longer used for keepout expansions.
# The values written below will be completely ignored.
# Instead, it will be set per positioner in the calibrations DB or config files.
# But I'm leaving them here for the moment, because at some point may want to restore ability to globally override.
KEEPOUT_EXPANSION_PHI_RADIAL    = 0.0 # [mm] radial distance to expand all phi keepouts (about KEEPOUT_PHI center point)
KEEPOUT_EXPANSION_PHI_ANGULAR   = 0.0 # [deg] angular amount to expand all phi keepouts (cw and ccw, about KEEPOUT_PHI center point)
KEEPOUT_EXPANSION_THETA_RADIAL  = 0.0 # [mm] radial distance to expand all theta keepouts (about KEEPOUT_THETA center point)
KEEPOUT_EXPANSION_THETA_ANGULAR = 0.0 # [deg] angular amount to expand all theta keepouts (cw and ccw, about KEEPOUT_THETA center point)

# Phi arm (R2) keepout polygon (c.f. DESI-0899)
KEEPOUT_PHI = '''[[3.967, 3.918, 3.269, -1.172, -1.172,  3.269,  3.918],
                  [0.000, 1.014, 1.583,  1.037, -1.037, -1.583, -1.014]]'''

# Theta arm (R1) keepout polygon (c.f. DESI-0899)
KEEPOUT_THETA  = '''[[ 0.814,  2.083,  2.613,  4.154,  4.695,  5.094, 5.094, 4.831, 4.235, 3.432, 2.280, -1.902, -2.007, -1.139, -0.170],
                     [-3.236, -2.707, -2.665, -2.759, -1.680, -0.540, 0.540, 1.291, 1.933, 2.283, 2.283, -0.935, -2.665, -3.137, -3.332]]'''

# Petal edges keepout polygon -- obsXY coordinate system (c.f. DESI-3453)
# in ptlXY
# KEEPOUT_PTL = '''[[ 20.260, 410.189, 399.175, 372.978, 325.837, 20.260,  20.260, 415.189, 415.189, 20.260],
#                   [  0.000,   0.000,  95.306, 171.109, 235.993, 13.978, 240.993, 240.993,  -5.000, -5.000]]'''
# in ptlXY, expanded
# KEEPOUT_PTL = '''[[ 20.260, 410.189, 410.0, 399.175, 399.0, 372.978, 325.837, 20.260, 20.260, 420.0, 420.0, 20.26 ],
#                   [  0.000,   0.000, 45.0 ,  105.306, 125.0, 171.109, 235.993, 13.978, 250.0 ,250.0 , -5.0, -5.0  ]]'''
# in flatXY, expanded
KEEPOUT_PTL = '''[[20.26005601, 410.7849431, 418.63957432, 406.9100602,  399.60662357, 384.58654873, 326.28936486, 20.26008304, 20.27039946, 420.80562452, 420.64551499, 20.26005907],
                  [ 0.        ,   0.       ,  32.29934515,  89.13363366, 125.19004498, 167.75585133, 236.32063296, 13.9780573, 250.12832498, 250.4795384,   -5.0076847,  -5.00001458]]'''

# GFA keepout polygon -- obsXY coordinate system (c.f. DESI-3453)
# in ptlXY
# KEEPOUT_GFA = '''[[295.569, 301.644, 303.538, 305.444, 307.547, 309.204, 320.770, 353.527],
#                   [207.451, 201.634, 201.588, 201.296, 201.131, 199.968, 184.033, 207.831]]'''
# in flatXY
KEEPOUT_GFA = '''[[295.89116973, 301.97618312, 303.87536306, 305.78637159, 307.89515189, 309.55559561, 321.13817537, 354.04033372],
                  [207.67712125, 201.85604788, 201.81205216, 201.5216323,  201.35868597, 200.19538345, 184.24423053, 208.13277797]]'''

# Parameters for plotting visualizations
FERRULE_DIAM = 1.250 # [mm] diameter of fiber ferrule
FERRULE_RESLN =   10 # number of points for polygon representation of ferrule